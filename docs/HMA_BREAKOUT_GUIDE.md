# HMA Breakout 策略使用指南

## 策略概述

HMA Breakout 策略基于 Hull Moving Average (HMA) 指标，通过三个不同周期的 HMA 交叉来生成交易信号。

### 策略逻辑

- **多头信号（绿色）**：HMA3 < HMA2 且 HMA3 < HMA1 且 HMA1 > HMA2
- **空头信号（红色）**：HMA3 > HMA2 且 HMA3 > HMA1 且 HMA2 > HMA1
- **平仓信号（灰色）**：不满足多头或空头条件

### 交易规则

1. **开仓**：收到多头或空头信号时开仓，同时在币安设置 -40% ROI 止损单
2. **平仓**：收到平仓信号时平仓（会自动取消止损单）
3. **持仓管理**：只要颜色不变，保持当前仓位
4. **止损**：开仓时在币安设置止损单，ROI 达到 -40% 时自动触发
5. **杠杆**：10倍杠杆，全仓交易

## 快速开始

### 1. 环境准备

```bash
# 安装依赖
pip install -r requirements.txt
```

### 2. 配置环境变量

复制 `.env.example` 为 `.env` 并配置：

```bash
# Binance API 配置
BINANCE_API_KEY=your_api_key
BINANCE_API_SECRET=your_api_secret

# Telegram 配置
TELEGRAM_BOT_TOKEN=your_bot_token
TELEGRAM_CHAT_ID=your_chat_id

```

### 3. 配置策略参数

编辑 `config.toml` 文件：

```toml
# HMA Breakout 策略配置
[hma_strategy]
# HMA 参数
hma1 = 10
hma2 = 20
hma3 = 100

# K 线周期
kline_interval = "5m"  # 5分钟K线

# 交易配置
[trading]
# 杠杆倍数
leverage = 10
# 交易模式：'cross' 为全仓，'isolated' 为逐仓
margin_type = "cross"
# 止损配置
stop_loss_roi = -0.40  # 投资回报率 -40% 止损
```

### 4. 运行策略

```bash
# 运行 HMA Breakout 策略
python main_hma.py
```

## 完整流程

### 初始化阶段

1. **加载配置**：从 `config.toml` 和 `.env` 加载配置
2. **初始化组件**：
   - K 线管理器
   - HMA 指标计算器
   - 策略信号生成器
   - 仓位管理器
   - 交易执行器
   - Telegram 通知客户端
3. **设置杠杆和保证金模式**：设置 10 倍杠杆和全仓模式
4. **获取账户信息**：获取当前账户余额
5. **检查现有持仓**：同步交易所的持仓信息
6. **加载历史数据**：从 Binance REST API 获取 200 根历史 K 线
7. **发送启动通知**：通过 Telegram 发送启动消息

### 运行阶段

1. **WebSocket 连接**：
   - 连接到 Binance WebSocket，订阅 K 线数据流
   - 连接到用户数据流，监听订单更新
2. **实时数据处理**：
   - 接收实时 K 线更新
   - 更新当前 K 线数据
3. **K 线关闭时处理**：
   - 将 K 线加入历史数据
   - 计算 HMA 指标
   - 生成交易信号
   - 处理交易逻辑
4. **订单更新处理**：
   - 监听止损单成交
   - 止损触发时自动平仓并发送通知

### 信号处理逻辑

#### 信号生成规则

- **GREEN 信号**：仅在颜色从其他状态变为 GREEN 时生成（颜色反转）
- **RED 信号**：仅在颜色从其他状态变为 RED 时生成（颜色反转）
- **GRAY 信号**：当颜色为 GRAY 时始终生成（无论是否反转）

#### 无持仓时

```
等待信号 → 收到 GREEN 信号（颜色反转）→ 开多仓 → 设置止损 → 发送通知
等待信号 → 收到 RED 信号（颜色反转）→ 开空仓 → 设置止损 → 发送通知
等待信号 → 收到 GRAY 信号 → 不开仓，保持空仓
```

#### 有持仓时

```
收到 GREEN 信号（颜色反转）→ 检查持仓类型 → 空仓则平空仓开多仓 → 多仓则保持
收到 RED 信号（颜色反转）→ 检查持仓类型 → 多仓则平多仓开空仓 → 空仓则保持
收到 GRAY 信号 → 平仓 → 发送通知
```

#### 重要规则

- **开仓条件**：只有在颜色变为 GREEN 或 RED 时才能开仓（颜色反转）
- **持仓保持**：颜色保持 GREEN 或 RED 时，保持当前持仓，不开新仓
- **平仓条件**：
  - 收到 GRAY 信号时平仓
  - 信号反转时先平旧仓再开新仓（如：空仓时收到 GREEN 信号，先平空仓再开多仓）

#### 止损

止损在开仓时自动在币安设置，通过用户数据流监听止损单成交：

```
开仓 → 在币安设置 -40% ROI 止损单 → 用户数据流监听订单更新 → 止损单成交 → 自动平仓 → 发送通知
```

平仓时会自动取消止损单。

## 配置说明

### HMA 策略参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| hma1 | 短期 HMA 周期 | 10 |
| hma2 | 中期 HMA 周期 | 20 |
| hma3 | 长期 HMA 周期 | 100 |

### 交易参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| leverage | 杠杆倍数 | 10 |
| margin_type | 保证金模式 | cross |
| stop_loss_roi | 止损 ROI | -0.40 |

### 数据管理参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| max_klines | 最大保留 K 线数 | 200 |
| init_klines | 初始化获取的 K 线数 | 200 |

## Telegram 通知

### 启动通知

```
🚀 HMA Breakout 机器人已启动

交易对: BTCUSDC
K线周期: 5m
杠杆: 10倍
策略: HMA Breakout
账户余额: 1000.00 USDT
止损: -40%
```

### 开仓通知

```
🟢 开仓通知

交易对: BTCUSDC
方向: 做多
入场价格: 50000.00
数量: 0.2000
杠杆: 10x
止损价格: 48000.00 (-40%)
```

### 平仓通知

#### 正常平仓（信号变化）

```
🟢 平仓通知

交易对: BTCUSDC
方向: LONG
入场价格: 50000.00
平仓价格: 51000.00
盈亏: 2.00%
盈亏金额: 20.00 USDT
原因: 平仓信号
```

#### 止损平仓

```
🔴 平仓通知

交易对: BTCUSDC
方向: LONG
入场价格: 50000.00
平仓价格: 48000.00
盈亏: -4.00%
盈亏金额: -40.00 USDT
原因: 止损触发
```

## 风险提示

1. **高风险策略**：10倍杠杆全仓交易风险极高
2. **止损设置**：-40% 止损意味着可能损失 40% 的本金
3. **市场风险**：加密货币市场波动剧烈
4. **技术风险**：网络中断、API 故障等可能导致交易失败
5. **策略风险**：历史表现不代表未来收益

## 常见问题

### Q: 如何调整止损比例？

A: 修改 `config.toml` 中的 `stop_loss_roi`：

```toml
[trading]
stop_loss_roi = -0.30  # 改为 -30%
```

### Q: 如何查看当前持仓？

A: 程序启动时会自动同步交易所的持仓信息，也可以通过 Telegram 通知查看。

## 技术支持

如有问题，请检查：
1. 日志文件：`logs/app.log`
2. Telegram 通知消息
3. Binance API 密钥是否正确
4. 网络连接是否正常

## 免责声明

本策略仅供学习和研究使用，不构成投资建议。使用本策略进行交易的所有风险由使用者自行承担。作者不对任何损失负责。