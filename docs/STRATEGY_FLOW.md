# 5分钟K线交易策略流程

## 策略概述

本策略基于5分钟K线周期，使用5分钟K线方向作为开仓信号，每次5m K线关闭时检查开仓条件。

**重要原则**：
1. 所有开仓判断都基于已关闭的K线数据，确保数据的确定性和可靠性
2. **状态持久化**：启动时自动从Binance API同步持仓状态，避免重启后"逻辑空仓但真实有仓"的风险

## 交易流程

### 1. 5分钟K线关闭
- **触发时机**：每次5分钟K线**完全关闭后**
- **判断条件**：
  - **K线状态**：5m K线必须已关闭（`is_closed == True`）
- **重要说明**：
  - 只有在5m K线完全关闭后才会触发此事件
  - 此时5m K线的OHLCV数据已经确定，可以安全地进行判断
- **操作**：
  - 检查是否有持仓
  - 如果有持仓，检查反向吞没止损
  - 如果没有持仓，检查开仓条件

### 2. 开仓条件检查

#### 2.1 获取5m K线方向
- **关键**：获取当前**已完全关闭**的5m K线
- 确保K线已关闭（`is_closed == True`）
- 判断K线方向：
  - **UP**：收盘价 > 开盘价（阳线）
  - **DOWN**：收盘价 < 开盘价（阴线）

#### 2.2 成交量检查
- **关键**：使用已关闭的5m K线数据
- 计算当前5m K线的成交量（已关闭）
- 计算最近5根已关闭5m K线的平均成交量
- **条件**：当前成交量 / 平均成交量 ≥ 0.80

#### 2.3 K线振幅检查
- **关键**：使用已关闭的5m K线数据
- 计算当前5m K线的振幅（已关闭）：最高价 - 最低价
- 计算最近5根已关闭5m K线的平均振幅
- **条件**：当前振幅 / 平均振幅 ≥ 0.5（可在配置文件中调整）
- **目的**：
  - 确保当前K线有足够的波动性
  - 避免在市场平静时开仓
  - 振幅大表示市场活跃，有交易机会

#### 2.4 K线实体比例检查
- **关键**：使用已关闭的5m K线数据
- 计算K线实体长度：|收盘价 - 开盘价|
- 计算K线整体振幅：最高价 - 最低价（包含上影线和下影线）
- 计算实体比例：实体长度 / 整体振幅
- 计算上影线长度：最高价 - max(开盘价, 收盘价)
- 计算下影线长度：min(开盘价, 收盘价) - 最低价
- 计算上影线比例：上影线长度 / 整体振幅
- 计算下影线比例：下影线长度 / 整体振幅
- **条件**：
  1. 实体比例 ≥ 0.7（可在配置文件中调整）
  2. 上影线比例 < 40%（可在配置文件中调整）
  3. 下影线比例 < 40%（可在配置文件中调整）
- **说明**：
  - 实体比例反映了K线实体在整个振幅中的占比
  - 影线检查防止单边影线过长的情况
  - 如果单边影线超过整体振幅的50%，说明存在较强的阻力或支撑
  - 实体比例高且影线比例适中说明K线实体占主导，趋势明确

#### 2.5 趋势过滤检查（重要！避免震荡市假突破）
- **关键**：使用已关闭的5m K线数据
- 计算MA20（20周期移动平均线）
- 判断MA20方向：当前MA20 > 上一根MA20 = 上升，否则 = 下降
- 判断价格位置：当前价格 > MA20 = 上方，否则 = 下方
- **条件**：
  - **做多（LONG）**：
    1. 5m K线方向为UP
    2. 价格在MA20上方
    3. MA20方向为上升
  - **做空（SHORT）**：
    1. 5m K线方向为DOWN
    2. 价格在MA20下方
    3. MA20方向为下降
- **说明**：
  - 趋势过滤用于避免震荡市的假突破和骗线
  - 确保开仓方向与整体趋势一致
  - 减少在震荡市中的频繁止损
  - MA20是常用的中期趋势指标，能有效过滤短期噪音

### 3. 开仓决策

#### 开仓条件（必须全部满足）
1. ✅ 5m K线已完全关闭（数据确定）
2. ✅ 5m K线方向确定（UP或DOWN）
3. ✅ 成交量满足阈值要求（≥ 0.80倍平均成交量）
4. ✅ K线振幅满足阈值要求（≥ 0.5倍平均振幅）
5. ✅ K线实体比例满足阈值要求（≥ 0.7）
6. ✅ 单边影线比例不超过阈值（默认40%，防止单边影线过长）
7. ✅ 趋势过滤通过（价格与MA20方向一致，避免震荡市假突破）
8. ✅ 当前没有持仓

#### 开仓方向
- **做多（LONG）**：5m K线方向为UP（基于已关闭的5m K线）
- **做空（SHORT）**：5m K线方向为DOWN（基于已关闭的5m K线）

#### 仓位大小（基于风险管理的动态仓位）
- **风险管理原则**：最大单笔亏损限制为账户余额的5%
- **仓位计算公式**：
  - 基于风险的仓位价值 = (账户余额 × 最大亏损比例) / 止损距离百分比
  - 基于杠杆的仓位价值 = 账户余额 × 杠杆倍数
  - 实际仓位价值 = min(基于风险的仓位价值, 基于杠杆的仓位价值)
- **止损距离计算**：
  - 基于振幅的止损距离 = 最新5m K线振幅 × 0.8
  - 最小止损距离 = 当前价格 × 0.5%
  - 最终止损距离 = max(基于振幅的止损距离, 最小止损距离)
  - 止损距离百分比 = 最终止损距离 / 当前价格
- **示例计算**：
  - 账户余额：1000 USDC
  - 最大亏损比例：5%（50 USDC）
  - 止损距离：0.5%（价格100 USDC，止损99.5 USDC）
  - 基于风险的仓位价值 = 1000 × 0.05 / 0.005 = 10,000 USDC
  - 杠杆倍数：10x
  - 基于杠杆的仓位价值 = 1000 × 10 = 10,000 USDC
  - 实际仓位价值 = min(10,000, 10,000) = 10,000 USDC
  - 有效杠杆 = 10,000 / 1,000 = 10x
- **优势**：
  - 自动根据止损距离调整仓位大小
  - 止损距离大时仓位小，止损距离小时仓位大
  - 确保单笔最大亏损不超过账户余额的5%
  - 从"赌博模型"升级为"交易模型"
- **杠杆倍数**：可配置（默认10倍）
- **手续费和安全边际**：已包含在仓位计算中

### 4. 设置移动止损订单
- **触发时机**：开仓成功后立即设置，每次5m K线关闭时更新
- **重要前提**：
  - 止损订单仅在开仓订单成功成交后设置
  - 如果开仓订单未成交（订单失败），系统不会设置止损订单
  - 系统会取消所有未成交订单，避免产生挂单
- **止损价格计算**：
  - 基于振幅的止损距离 = 最新5m K线振幅 × 0.8（可在配置文件中调整）
  - 最小止损距离 = 当前价格 × 0.5%（可在配置文件中调整）
  - 最终止损距离 = max(基于振幅的止损距离, 最小止损距离)
  - 做多止损价格 = 当前价格 - 最终止损距离
  - 做空止损价格 = 当前价格 + 最终止损距离
- **止损订单类型**：STOP_MARKET（止损市价单）
- **实现机制**：
  1. 查询现有止损单（检查是否存在STOP_MARKET且reduceOnly=True的订单）
  2. 如果存在旧止损单，先取消旧订单
  3. 根据最新5m K线振幅计算新的止损价格
  4. 创建新的止损订单
  5. 等待0.5秒确保取消操作完成后再创建新订单
- **重要说明**：
  - 这是**移动止损**，每次5m K线关闭时基于最新的5m K线振幅重新计算
  - 止损价格会随着市场波动动态调整
  - 阈值设为0.8，避免与反向吞没止损（0.7）冲突
  - **最小止损距离保护**：在低波动时，止损距离不会过窄，避免被轻易扫止损
  - **自动更新机制**：系统会自动取消旧止损单并创建新止损单，无需手动干预
- **目的**：
  - 限制单笔交易的最大亏损
  - 基于最新K线振幅动态调整止损距离
  - 振幅大时止损距离大，振幅小时止损距离小
  - 随市场变化动态调整，更加灵活
  - 防止低波动时止损过窄被扫
  - 锁定利润：当价格向有利方向移动时，止损跟随移动以保护已实现的利润

### 5. 移动反向吞没止损检查
- **触发时机**：每次5m K线关闭时检查
- **检查条件**：
  - 当前K线方向与**上一根**K线方向相反
  - 当前K线实体长度 / 上一根K线实体长度 ≥ 0.7（可在配置文件中调整）
- **操作**：
  - 如果满足条件，立即平仓
  - 发送止损通知
- **目的**：
  - 快速响应市场反转信号
  - 避免在趋势反转时继续持有仓位
  - 基于K线实体比例动态判断反转强度
- **重要说明**：
  - 这是**移动检查**，每次5m K线关闭时都检查当前K线与上一根K线的关系
  - 不是与开仓K线对比，而是与**上一根K线**对比
  - 只要出现反向吞没且实体比例达到阈值，就立即止损

### 6. 平仓条件
持仓会在以下任一条件满足时平仓：

#### 6.1 固定止损触发
- 止损订单被触发（价格触及止损价格）
- 自动市价平仓

#### 6.2 移动反向吞没止损触发
- 当前5m K线与上一根5m K线形成反向吞没模式
- 吞没比例 ≥ 0.7
- 立即市价平仓

## 配置参数

### K线周期
- **主周期**：5m（交易周期）

### 成交量参数
- **成交量比例阈值**：0.80（可在配置文件中调整）
- **计算基准**：最近5根已关闭5m K线的平均成交量

### K线振幅参数
- **振幅比例阈值**：0.5（可在配置文件中调整）
- **计算基准**：最近5根已关闭5m K线的平均振幅
- **计算方式**：振幅 = 最高价 - 最低价

### K线实体参数
- **实体比例阈值**：0.7（可在配置文件中调整）
- **计算方式**：实体长度 / 整体振幅

### K线影线参数
- **影线比例阈值**：0.4（可在配置文件中调整）
- **计算方式**：影线长度 / 整体振幅
- **检查条件**：上影线比例 < 阈值 且 下影线比例 < 阈值
### 风险管理参数
- **最大单笔亏损比例**：5%（可在配置文件中调整）
- **仓位计算方式**：基于止损距离的动态仓位计算
- **计算公式**：
  - 基于风险的仓位价值 = (账户余额 × 最大亏损比例) / 止损距离百分比
  - 基于杠杆的仓位价值 = 账户余额 × 杠杆倍数
  - 实际仓位价值 = min(基于风险的仓位价值, 基于杠杆的仓位价值)
- **优势**：
  - 自动根据止损距离调整仓位大小
  - 确保单笔最大亏损不超过账户余额的5%
  - 从"赌博模型"升级为"交易模型"
  - 降低爆仓风险，提高资金使用效率


### 移动止损参数
- **止损振幅倍数**：0.8（可在配置文件中调整）
- **最小止损距离百分比**：0.5%（可在配置文件中调整）
- **止损距离计算**：max(最新5m K线振幅 × 止损振幅倍数, 当前价格 × 最小止损距离百分比)
- **做多止损价格**：当前价格 - 最终止损距离
- **做空止损价格**：当前价格 + 最终止损距离
- **重要说明**：
  - 这是移动止损，每次5m K线关闭时基于最新的5m K线振幅重新计算
  - 最小止损距离保护防止低波动时止损过窄

### 趋势过滤参数
- **趋势过滤开关**：true（可在配置文件中调整）
- **MA周期**：20（可在配置文件中调整）
- **做多条件**：价格 > MA20 且 MA20上升
- **做空条件**：价格 < MA20 且 MA20下降
- **重要说明**：趋势过滤用于避免震荡市的假突破，减少频繁止损

### 移动反向吞没止损参数
- **吞没实体比例阈值**：0.7（可在配置文件中调整）
- **检查条件**：当前K线实体 / 上一根K线实体 ≥ 阈值 且 方向相反
- **触发操作**：立即平仓
- **重要说明**：这是移动检查，每次5m K线关闭时都检查当前K线与上一根K线的关系

### 交易参数
- **杠杆倍数**：可配置（默认20倍）
- **仓位大小**：100%账户余额
- **手续费率**：0.04%（市价单taker费率）
- **安全边际**：1%

## 数据流

### WebSocket订阅
- `ticker`：实时价格数据
- `kline_5m`：5分钟K线数据

### 历史数据加载
- 5m K线：100根

## 通知机制

### Telegram通知

#### 1. 指标分析通知
在每次检查开仓条件时发送，包含：
- 5m K线时间
- 当前价格
- 5m K线方向
- 成交量信息
- K线振幅信息
- K线实体比例信息
- 交易决策（LONG/SHORT/NO_TRADE）

#### 2. 交易通知
开仓成功时发送，包含：
- 交易对
- 方向（做多/做空）
- 开仓价格
- 数量
- 仓位价值
- 杠杆倍数
- 5m K线时间
- 成交量信息
- K线振幅信息
- 止损价格
- 仓位计算详情

#### 3. 平仓通知
平仓时发送，包含：
- 交易对
- 方向
- 开仓价格
- 平仓价格
- 数量
- 盈亏

#### 4. 止损通知


### 资金管理（基于风险管理的动态仓位）
- **最大单笔亏损限制**：账户余额的5%（可在配置文件中调整）
- **动态仓位计算**：
  - 根据止损距离自动调整仓位大小
  - 止损距离大时仓位小，止损距离小时仓位大
  - 确保单笔最大亏损不超过设定阈值
- **杠杆控制**：可配置杠杆倍数（默认10倍）
- **手续费考虑**：已包含在仓位计算中
- **安全边际**：1%的安全边际，防止保证金不足
- **风险控制优势**：
  - 从"赌博模型"升级为"交易模型"
  - 降低爆仓风险
  - 提高资金使用效率
  - 更好的您发送的内容疑似存在以下问题：【违禁】，已被拦截。
止损触发时发送，包含：
- 止损类型（固定止损/反向吞没止损）
- 交易对
- 开仓方向
- 当前方向（反向吞没时）
- 吞没比例（反向吞没时）
- 阈值

## 风险控制

### 单笔交易风险
- 移动止损：基于最新5m K线振幅的0.8倍，每次5m K线关闭时更新
- 移动反向吞没止损：当当前5m K线与上一根5m K线反向吞没 >= 70% 实体时立即止损
- 无持仓时间限制：持仓时间由止损条件决定
- 止损阈值设计：移动止损（0.8）> 反向吞没止损（0.7），避免冲突

### 资金管理
- 全仓交易：100%账户余额
- 杠杆控制：可配置杠杆倍数
- 手续费考虑：已包含在仓位计算中

## 示例场景

### 场景1：做多
1. 5m K线关闭（10:05）
   - K线方向：UP（阳线）
   - 成交量：平均成交量的0.9倍 ✅
   - 振幅：平均振幅的0.6倍 ✅
   - 实体比例：0.75 ✅
   - 影线比例：上影线25%，下影线15% ✅
2. 开多仓
3. 设置止损订单
4. 持仓等待止损触发或反向吞没

### 场景2：不交易
1. 5m K线关闭（10:05）
   - K线方向：UP（阳线）
   - 成交量：平均成交量的0.6倍 ❌
2. 不开仓，等待下一个5m K线

### 场景3：移动反向吞没止损
1. 开多仓（10:05）
2. 持仓期间，5m K线关闭（10:10）
   - 上一根K线方向：UP（阳线）
   - 当前K线方向：DOWN（阴线，与上一根方向相反）
   - 当前实体长度 / 上一根实体长度 = 0.8 ≥ 0.7 ✅
3. 触发移动反向吞没止损，立即平仓

## 关键特性

1. **简单明确**：只使用5m K线方向，无需复杂指标
2. **快速执行**：在5m K线关闭后立即开仓
3. **动态止损**：移动止损（基于最新K线振幅）+ 移动反向吞没止损（基于相邻K线对比）
4. **风险可控**：固定止损 + 移动反向吞没止损，避免过度亏损
5. **实时通知**：完整的Telegram通知系统
6. **灵活持仓**：无固定持仓时间限制，由市场决定

## 注意事项

1. 确保WebSocket连接稳定
2. 确保账户余额充足
3. 注意市场波动风险
4. 关注手续费成本
5. 定期检查系统日志
6. 止损订单可能因市场剧烈波动而滑点

## 代码结构

### 主要文件
- `../src/strategy/fifteen_minute_strategy.py`：策略实现（类名为FiveMinuteStrategy）
- `../src/indicators/technical_analyzer.py`：技术指标计算
- `../src/trading/trading_executor.py`：交易执行
- `../src/trading/position_manager.py`：仓位管理
- `../src/telegram/telegram_client.py`：Telegram通知
- `../config.toml`：配置文件

### 关键方法
- `on_5m_kline_close()`：处理5m K线关闭（已关闭，触发开仓检查和止损检查）
- `_check_and_open_position()`：检查并开仓（基于已关闭的5m K线）
- `_check_volume_condition()`：检查成交量（基于已关闭的5m K线）
- `_check_range_condition()`：检查振幅（基于已关闭的5m K线）
- `_check_body_ratio()`：检查实体比例（基于已关闭的5m K线）
- `_calculate_stop_loss_price()`：计算止损价格
- `_set_stop_loss_order()`：设置止损订单
- `_check_engulfing_stop_loss()`：检查反向吞没止损

### 数据安全保证
- 所有开仓判断都基于**已关闭**的K线数据
- WebSocket事件只在K线完全关闭后才触发
- 确保数据的确定性和可重复性
- 避免使用未完成K线的不确定数据

### 状态持久化保证
- **启动时同步**：系统启动时自动从Binance API查询当前持仓
- **自动恢复**：将交易所的真实持仓状态同步到本地持仓管理器
- **风险防范**：避免程序重启后出现"逻辑空仓但真实有仓"的灾难性风险
- **一致性保证**：确保本地持仓状态与交易所持仓状态保持一致

## 策略变更说明

### 从15m策略到5m策略的主要变更

1. **移除15m周期概念**：不再有15m周期的限制
2. **开仓逻辑变更**：每次5m K线关闭都检查开仓条件，不再限制为第一个5m K线
3. **平仓逻辑变更**：移除15m K线关闭时的强制平仓，改为由止损条件决定平仓时机
4. **持仓时间**：无固定持仓时间限制，由市场走势决定
5. **仓位管理**：同时只能持有一个仓位（开新仓前必须先平掉旧仓）
6. **止损机制**：保留固定止损和反向吞没止损，作为主要的平仓触发条件

### 优势
- 更灵活的交易机会捕捉
- 不受固定时间限制，让市场决定持仓时间
- 更快响应市场变化
- 减少因时间限制导致的强制平仓