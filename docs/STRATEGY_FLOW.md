# 5分钟K线交易策略流程

## 策略概述

本策略基于5分钟K线周期，使用5分钟K线方向作为开仓信号，每次5m K线关闭时检查开仓条件。

**重要原则**：
1. 所有开仓判断都基于已关闭的K线数据，确保数据的确定性和可靠性
2. **状态持久化**：启动时自动从Binance API同步持仓状态，避免重启后"逻辑空仓但真实有仓"的风险

## 交易流程

### 1. 5分钟K线关闭
- **触发时机**：每次5分钟K线**完全关闭后**
- **判断条件**：
  - **K线状态**：5m K线必须已关闭（`is_closed == True`）
- **重要说明**：
  - 只有在5m K线完全关闭后才会触发此事件
  - 此时5m K线的OHLCV数据已经确定，可以安全地进行判断
- **操作**：
  - 检查是否有持仓
  - 如果有持仓，检查反向吞没止损
  - 如果有持仓且启用移动止损，更新移动止损
  - 如果没有持仓，检查开仓条件

### 2. 开仓条件检查

#### 2.1 获取5m K线方向
- **关键**：获取当前**已完全关闭**的5m K线
- 确保K线已关闭（`is_closed == True`）
- 判断K线方向：
  - **UP**：收盘价 > 开盘价（阳线）
  - **DOWN**：收盘价 < 开盘价（阴线）

#### 2.2 成交量检查
- **关键**：使用已关闭的5m K线数据
- 计算当前5m K线的成交量（已关闭）
- 计算最近5根已关闭5m K线的平均成交量
- **条件**：当前成交量 / 平均成交量 ≥ 0.80

#### 2.3 K线振幅检查
- **关键**：使用已关闭的5m K线数据
- 计算当前5m K线的振幅（已关闭）：最高价 - 最低价
- 计算最近5根已关闭5m K线的平均振幅
- **条件**：当前振幅 / 平均振幅 ≥ 0.5（可在配置文件中调整）
- **目的**：
  - 确保当前K线有足够的波动性
  - 避免在市场平静时开仓
  - 振幅大表示市场活跃，有交易机会

#### 2.4 K线实体比例检查
- **关键**：使用已关闭的5m K线数据
- 计算K线实体长度：|收盘价 - 开盘价|
- 计算K线整体振幅：最高价 - 最低价（包含上影线和下影线）
- 计算实体比例：实体长度 / 整体振幅
- 计算上影线长度：最高价 - max(开盘价, 收盘价)
- 计算下影线长度：min(开盘价, 收盘价) - 最低价
- 计算上影线比例：上影线长度 / 整体振幅
- 计算下影线比例：下影线长度 / 整体振幅
- **条件**：
  1. 实体比例 ≥ 0.7（可在配置文件中调整）
  2. 上影线比例 < 40%（可在配置文件中调整）
  3. 下影线比例 < 40%（可在配置文件中调整）
- **说明**：
  - 实体比例反映了K线实体在整个振幅中的占比
  - 影线检查防止单边影线过长的情况
  - 如果单边影线超过整体振幅的50%，说明存在较强的阻力或支撑
  - 实体比例高且影线比例适中说明K线实体占主导，趋势明确

#### 2.5 趋势过滤检查（重要！避免震荡市假突破）
- **关键**：使用已关闭的5m K线数据
- 计算MA20（20周期移动平均线）
- 判断MA20方向：当前MA20 > 上一根MA20 = 上升，否则 = 下降
- 判断价格位置：当前价格 > MA20 = 上方，否则 = 下方
- **条件**：
  - **做多（LONG）**：
    1. 5m K线方向为UP
    2. 价格在MA20上方
    3. MA20方向为上升
  - **做空（SHORT）**：
    1. 5m K线方向为DOWN
    2. 价格在MA20下方
    3. MA20方向为下降
- **说明**：
  - 趋势过滤用于避免震荡市的假突破和骗线
  - 确保开仓方向与整体趋势一致
  - 减少在震荡市中的频繁止损
  - MA20是常用的中期趋势指标，能有效过滤短期噪音

### 3. 开仓决策

#### 开仓条件（必须全部满足）
1. ✅ 5m K线已完全关闭（数据确定）
2. ✅ 5m K线方向确定（UP或DOWN）
3. ✅ 成交量满足阈值要求（≥ 0.80倍平均成交量）
4. ✅ K线振幅满足阈值要求（≥ 0.5倍平均振幅）
5. ✅ K线实体比例满足阈值要求（≥ 0.7）
6. ✅ 单边影线比例不超过阈值（默认40%，防止单边影线过长）
7. ✅ 趋势过滤通过（价格与MA20方向一致，避免震荡市假突破）
8. ✅ 当前没有持仓

#### 开仓方向
- **做多（LONG）**：5m K线方向为UP（基于已关闭的5m K线）
- **做空（SHORT）**：5m K线方向为DOWN（基于已关闭的5m K线）

#### 仓位大小（基于风险管理的动态仓位）
- **风险管理原则**：最大单笔亏损限制为账户余额的5%
- **仓位计算公式**：
  - 基于风险的仓位价值 = (账户余额 × 最大亏损比例) / 止损距离百分比
  - 基于杠杆的仓位价值 = 账户余额 × 杠杆倍数
  - 实际仓位价值 = min(基于风险的仓位价值, 基于杠杆的仓位价值)
- **止损距离计算**：
  - 基于振幅的止损距离 = 最新5m K线振幅 × 0.8
  - 最小止损距离 = 当前价格 × 0.5%
  - 最终止损距离 = max(基于振幅的止损距离, 最小止损距离)
  - 止损距离百分比 = 最终止损距离 / 当前价格
- **示例计算**：
  - 账户余额：1000 USDC
  - 最大亏损比例：5%（50 USDC）
  - 止损距离：0.5%（价格100 USDC，止损99.5 USDC）
  - 基于风险的仓位价值 = 1000 × 0.05 / 0.005 = 10,000 USDC
  - 杠杆倍数：10x
  - 基于杠杆的仓位价值 = 1000 × 10 = 10,000 USDC
  - 实际仓位价值 = min(10,000, 10,000) = 10,000 USDC
  - 有效杠杆 = 10,000 / 1,000 = 10x
- **优势**：
  - 自动根据止损距离调整仓位大小
  - 止损距离大时仓位小，止损距离小时仓位大
  - 确保单笔最大亏损不超过账户余额的5%
  - 从"赌博模型"升级为"交易模型"
- **杠杆倍数**：可配置（默认10倍）
- **手续费和安全边际**：已包含在仓位计算中

### 4. 实时监控止损机制

#### 4.1 实时监控平仓机制
- **重要变更**：系统已从止损订单（STOP_MARKET）改为实时监控平仓
- **工作原理**：
  - 开仓时计算止损价格并存储在内存中
  - 每次5分钟K线关闭时检查止损条件
  - 当价格触及止损价格时，立即执行市价平仓
- **优势**：
  - ✅ 避免止损订单管理复杂性
  - ✅ 避免条件单（algo orders）的取消问题
  - ✅ 更灵活的止损逻辑控制
  - ✅ 减少订单管理错误

#### 4.2 止损价格计算
- **计算时机**：开仓时计算并存储在持仓信息中
- **计算公式**：
  - 基于振幅的止损距离 = 最新5m K线振幅 × 0.6（可在配置文件中调整）
  - 最小止损距离 = 当前价格 × 0.5%（可在配置文件中调整）
  - 最终止损距离 = max(基于振幅的止损距离, 最小止损距离)
  - 做多止损价格 = 当前价格 - 最终止损距离
  - 做空止损价格 = 当前价格 + 最终止损距离
- **存储位置**：持仓信息中的 `stop_loss_price` 字段

#### 4.3 实时监控检查
- **触发时机**：每次5分钟K线关闭时
- **检查内容**：
  1. 获取当前价格
  2. 计算当前K线振幅
  3. 基于当前振幅重新计算止损距离
  4. 判断是否触发止损
- **触发条件**：
  - 做多持仓：当前价格 ≤ 止损价格
  - 做空持仓：当前价格 ≥ 止损价格
- **执行操作**：
  - 立即执行市价平仓
  - 发送止损通知
  - 更新持仓状态

#### 4.4 启动时的持仓同步（重要安全机制）
- **触发时机**：每次系统启动时自动执行
- **检查内容**：
  1. 从Binance API查询当前持仓
  2. 自动同步到本地持仓管理器
  3. 重建持仓信息（包括止损价格）
- **止损价格重建**：
  - 获取当前价格和最新5m K线数据
  - 基于当前K线振幅计算止损距离
  - 使用策略配置的止损参数（stop_loss_range_multiplier、stop_loss_min_distance_percent）
  - 根据持仓方向计算止损价格
  - 将止损价格存储到持仓信息中
- **目的**：
  - 避免重启后"逻辑空仓但真实有仓"的风险
  - 确保所有持仓都有止损保护（即使内存重置）
  - 提供自动恢复机制，减少人工干预
- **实现位置**：[`../src/trading/position_manager.py`](../src/trading/position_manager.py:139) 的 `sync_from_exchange` 方法
- **重要说明**：
  - 由于止损价格存储在内存中，系统重启后会丢失
  - 必须在启动时重新计算并存储止损价格
  - 确保重启后持仓仍然有止损保护

#### 4.5 重要说明
- 这是**动态止损**，每次5m K线关闭时基于最新的5m K线振幅重新计算
- 止损价格会随着市场波动动态调整
- 阈值设为0.6，避免与反向吞没止损（0.85）冲突
- **最小止损距离保护**：在低波动时，止损距离不会过窄，避免被轻易扫止损
- **实时监控机制**：系统会实时检查止损条件，无需管理订单
- **内存存储**：止损价格存储在内存中，重启后自动重建

#### 4.6 目的
- 限制单笔交易的最大亏损
- 基于最新K线振幅动态调整止损距离
- 振幅大时止损距离大，振幅小时止损距离小
- 随市场变化动态调整，更加灵活
- 防止低波动时止损过窄被扫
- 锁定利润：当价格向有利方向移动时，止损跟随移动以保护已实现的利润

### 5. 移动止损更新（已禁用）

- **状态**：已禁用（`trailing_stop_enabled = false`）
- **禁用原因**：
  - 与实时监控止损机制冲突
  - 实时监控止损每次K线关闭时重新计算，会覆盖移动止损设置
  - 导致止损价格忽高忽低，影响交易稳定性
- **当前止损机制**：
  - 只使用实时监控止损
  - 基于最新K线振幅动态调整
  - 最小止损距离3.0%，给价格更多波动空间
- **优势**：
  - 止损价格稳定，不会忽高忽低
  - 避免多个止损机制相互干扰
  - 更适合高波动市场

### 6. 止盈机制（新增）

- **触发时机**：每次价格更新时检查（基于WebSocket实时价格）
- **启用条件**：`take_profit_enabled = true`（可在配置文件中设置，默认启用）
- **工作原理**：
  - **多头持仓**：
    - 跟踪持仓期间的最高价格（peak_price）
    - 计算止盈价格 = 开仓价格 × (1 + take_profit_percent)
    - 当当前价格 ≥ 止盈价格时，触发止盈平仓
    - 如果启用移动止盈（take_profit_trailing_enabled），则：
      - 移动止盈价格 = peak_price × (1 - take_profit_trailing_percent)
      - 当价格从峰值回撤超过移动止盈百分比时，触发止盈
  - **空头持仓**：
    - 跟踪持仓期间的最低价格（peak_price）
    - 计算止盈价格 = 开仓价格 × (1 - take_profit_percent)
    - 当当前价格 ≤ 止盈价格时，触发止盈平仓
    - 如果启用移动止盈，则：
      - 移动止盈价格 = peak_price × (1 + take_profit_trailing_percent)
      - 当价格从峰值回撤超过移动止盈百分比时，触发止盈
- **止盈操作**：
  - 立即执行市价平仓
  - 发送止盈通知，包含盈亏信息
  - 更新持仓状态
- **目的**：
  - 主动锁定利润，避免利润回吐
  - 提高交易系统的盈利能力
  - 平衡风险和收益
- **重要说明**：
  - 止盈机制优先于止损检查
  - 峰值价格在开仓时初始化为开仓价格
  - 移动止盈可以最大化利润，同时保护已实现的收益
  - **优化参数**：止盈百分比5%，移动止盈百分比1.5%，适合10倍杠杆交易

### 7. 实时反向吞没止损检查
- **触发时机**：每次5m K线更新时实时检查（不等待K线关闭）
- **检查条件**（必须同时满足）：
   1. 当前K线方向与**上一根已关闭**K线方向相反
   2. 当前K线实体长度 / 上一根K线实体长度 ≥ 0.85（可在配置文件中调整）
   3. **真正的吞没形态**：当前K线完全包含上一根K线的价格范围
      - 做多持仓被触发时：当前K线是阳线，上一根是阴线，且当前开盘价 < 上一根收盘价 且 当前收盘价 > 上一根开盘价
      - 做空持仓被触发时：当前K线是阴线，上一根是阳线，且当前开盘价 > 上一根收盘价 且 当前收盘价 < 上一根开盘价
- **操作**：
   - 如果满足所有条件，立即平仓
   - 发送止损通知（标注"⚡ 实时监控，未等待K线关闭"）
- **目的**：
   - **快速响应市场反转信号**：实时监控，毫秒级响应
   - 避免在趋势反转时继续持有仓位
   - 基于K线实体比例动态判断反转强度
   - **避免误触发**：只有真正的吞没形态才会触发，防止因小幅波动导致的频繁止损
   - **减少亏损**：不等待K线关闭，立即平仓，减少损失
- **重要说明**：
   - 这是**实时检查**，每次5m K线更新时都检查（无论是否关闭）
   - 不是与开仓K线对比，而是与**上一根已关闭K线**对比
   - 必须同时满足实体比例阈值和真正的吞没形态才会触发
   - **响应速度**：从等待K线关闭（最多5分钟）改为实时监控（毫秒级）
   - **优势**：在快速反转市场中能够更快止损，减少亏损

### 8. 平仓条件
持仓会在以下任一条件满足时平仓：

#### 8.1 止盈触发（优先级最高）
- 价格触及止盈价格（基于开仓价格和止盈百分比）
- 或价格从峰值回撤超过移动止盈百分比（如果启用移动止盈）
- 立即执行市价平仓
- 发送止盈通知

#### 8.2 实时监控止损触发
- 价格触及止损价格（基于当前5m K线振幅动态计算）
- 立即执行市价平仓
- 发送止损通知

#### 8.3 移动反向吞没止损触发
- 当前5m K线与上一根5m K线形成反向吞没模式
- 吞没比例 ≥ 0.85
- **满足真正的吞没形态**：当前K线完全包含上一根K线的价格范围
- 立即市价平仓

## 配置参数

### K线周期
- **主周期**：5m（交易周期）

### 成交量参数
- **成交量比例阈值**：0.80（可在配置文件中调整）
- **计算基准**：最近5根已关闭5m K线的平均成交量

### K线振幅参数
- **振幅比例阈值**：0.5（可在配置文件中调整）
- **计算基准**：最近5根已关闭5m K线的平均振幅
- **计算方式**：振幅 = 最高价 - 最低价

### K线实体参数
- **实体比例阈值**：0.7（可在配置文件中调整）
- **计算方式**：实体长度 / 整体振幅

### K线影线参数
- **影线比例阈值**：0.4（可在配置文件中调整）
- **计算方式**：影线长度 / 整体振幅
- **检查条件**：上影线比例 < 阈值 且 下影线比例 < 阈值
### 风险管理参数
- **最大单笔亏损比例**：5%（可在配置文件中调整）
- **仓位计算方式**：基于止损距离的动态仓位计算
- **计算公式**：
  - 基于风险的仓位价值 = (账户余额 × 最大亏损比例) / 止损距离百分比
  - 基于杠杆的仓位价值 = 账户余额 × 杠杆倍数
  - 实际仓位价值 = min(基于风险的仓位价值, 基于杠杆的仓位价值)
- **优势**：
  - 自动根据止损距离调整仓位大小
  - 确保单笔最大亏损不超过账户余额的5%
  - 从"赌博模型"升级为"交易模型"
  - 降低爆仓风险，提高资金使用效率


### 实时监控止损参数
- **止损振幅倍数**：0.8（可在配置文件中调整）
- **最小止损距离百分比**：2.5%（可在配置文件中调整）
- **止损距离计算**：max(最新5m K线振幅 × 止损振幅倍数, 当前价格 × 最小止损距离百分比)
- **做多止损价格**：当前价格 - 最终止损距离
- **做空止损价格**：当前价格 + 最终止损距离
- **重要说明**：
  - 这是动态止损，每次5m K线关闭时基于最新的5m K线振幅重新计算
  - 最小止损距离保护防止低波动时止损过窄
  - 止损价格存储在内存中，实时监控触发条件
  - **平衡型配置**：2.5%最小止损距离，适合5分钟K线周期

### 趋势过滤参数
- **趋势过滤开关**：true（可在配置文件中调整）
- **MA周期**：20（可在配置文件中调整）
- **做多条件**：价格 > MA20 且 MA20上升
- **做空条件**：价格 < MA20 且 MA20下降
- **重要说明**：趋势过滤用于避免震荡市的假突破，减少频繁止损

### 移动止损参数
- **移动止损启用**：false（是否启用移动止损，可在配置文件中调整）
- **移动止损K线数**：5（移动止损参考的K线数量，可在配置文件中调整）
- **重要说明**：
  - 移动止损是可选功能，默认关闭
  - 需要在config.toml中显式启用
  - 可配置参考K线数量，灵活调整灵敏度
  - **优化参数**：K线数从3增加到5，降低敏感度，避免过早止损

### 止盈参数（新增）
- **止盈启用**：true（是否启用止盈，可在配置文件中调整）
- **止盈百分比**：0.035（3.5%，基于开仓价格的止盈目标）
- **移动止盈启用**：true（是否启用移动止盈，可在配置文件中调整）
- **移动止盈百分比**：0.015（1.5%，从峰值回撤触发止盈）
- **重要说明**：
  - 止盈机制默认启用，主动锁定利润
  - 移动止盈可以最大化利润，同时保护已实现的收益
  - **平衡型配置**：止损2.5%，止盈3.5%，移动止盈1.5%
  - **风险/收益比**：2.5%止损 / 3.5%止盈 = 1:1.4，适合5分钟K线周期
  - **优势**：止盈目标现实，容易达到，止盈机会多

### 移动反向吞没止损参数
- **吞没实体比例阈值**：0.85（可在配置文件中调整）
- **检查条件**（必须同时满足）：
  1. 当前K线实体 / 上一根K线实体 ≥ 阈值
  2. 当前K线方向与上一根K线方向相反
  3. **真正的吞没形态**：当前K线完全包含上一根K线的价格范围
- **触发操作**：立即平仓
- **重要说明**：
  - 这是移动检查，每次5m K线关闭时都检查当前K线与上一根K线的关系
  - 只有满足真正的吞没形态才会触发，避免因小幅波动导致的误触发

### 交易参数
- **杠杆倍数**：可配置（默认20倍）
- **仓位大小**：100%账户余额
- **手续费率**：0.04%（市价单taker费率）
- **安全边际**：1%

## 数据流

### WebSocket订阅
- `ticker`：实时价格数据
- `kline_5m`：5分钟K线数据

### 历史数据加载
- 5m K线：100根

## 通知机制

### Telegram通知

#### 1. 指标分析通知
在每次检查开仓条件时发送，包含：
- 5m K线时间
- 当前价格
- 5m K线方向
- 成交量信息
- K线振幅信息
- K线实体比例信息
- 交易决策（LONG/SHORT/NO_TRADE）

#### 2. 交易通知
开仓成功时发送，包含：
- 交易对
- 方向（做多/做空）
- 开仓价格
- 数量
- 仓位价值
- 杠杆倍数
- 5m K线时间
- 成交量信息
- K线振幅信息
- 止损价格
- 仓位计算详情

#### 3. 平仓通知
平仓时发送，包含：
- 交易对
- 方向
- 开仓价格
- 平仓价格
- 数量
- 盈亏

#### 4. 止损通知


### 资金管理（基于风险管理的动态仓位）
- **最大单笔亏损限制**：账户余额的5%（可在配置文件中调整）
- **动态仓位计算**：
  - 根据止损距离自动调整仓位大小
  - 止损距离大时仓位小，止损距离小时仓位大
  - 确保单笔最大亏损不超过设定阈值
- **杠杆控制**：可配置杠杆倍数（默认10倍）
- **手续费考虑**：已包含在仓位计算中
- **安全边际**：1%的安全边际，防止保证金不足
- **风险控制优势**：
  - 从"赌博模型"升级为"交易模型"
  - 降低爆仓风险
  - 提高资金使用效率
  - 更好的您发送的内容疑似存在以下问题：【违禁】，已被拦截。
止损触发时发送，包含：
- 止损类型（固定止损/反向吞没止损）
- 交易对
- 开仓方向
- 当前方向（反向吞没时）
- 吞没比例（反向吞没时）
- 阈值

## 风险控制

### 单笔交易风险
- 实时监控止损：基于最新5m K线振幅的0.6倍，每次价格更新时检查
- 移动止损：基于最近N根K线的高低点，每次5m K线关闭时更新（可选）
- 移动反向吞没止损：当当前5m K线与上一根5m K线反向吞没 >= 85% 实体时立即止损
- 无持仓时间限制：持仓时间由止损条件决定
- 止损阈值设计：实时监控止损（0.6）< 反向吞没止损（0.85），避免冲突

### 资金管理
- 全仓交易：100%账户余额
- 杠杆控制：可配置杠杆倍数
- 手续费考虑：已包含在仓位计算中

## 示例场景

### 场景1：做多
1. 5m K线关闭（10:05）
   - K线方向：UP（阳线）
   - 成交量：平均成交量的0.9倍 ✅
   - 振幅：平均振幅的0.6倍 ✅
   - 实体比例：0.75 ✅
   - 影线比例：上影线25%，下影线15% ✅
2. 开多仓
3. 存储止损价格到持仓信息
4. 持仓等待止损触发或反向吞没

### 场景2：不交易
1. 5m K线关闭（10:05）
   - K线方向：UP（阳线）
   - 成交量：平均成交量的0.6倍 ❌
2. 不开仓，等待下一个5m K线

### 场景3：移动反向吞没止损（不触发）
1. 开多仓（10:05）
2. 持仓期间，5m K线关闭（10:10）
   - 上一根K线方向：UP（阳线）
   - 当前K线方向：DOWN（阴线，与上一根方向相反）
   - 当前实体长度 / 上一根实体长度 = 0.8 ≥ 0.85 ❌（不触发）
3. 不触发止损，继续持仓

### 场景4：移动反向吞没止损（触发）
1. 开多仓（10:05）
2. 持仓期间，5m K线关闭（10:10）
   - 上一根K线方向：UP（阳线），开盘价68000，收盘价68060
   - 当前K线方向：DOWN（阴线，与上一根方向相反），开盘价68070，收盘价67990
   - 当前实体长度 / 上一根实体长度 = 0.9 ≥ 0.85 ✅
   - **真正的吞没形态检查**：当前开盘价(68070) > 上一根收盘价(68060) 且 当前收盘价(67990) < 上一根开盘价(68000) ✅
3. 触发移动反向吞没止损，立即平仓

## 关键特性

1. **简单明确**：只使用5m K线方向，无需复杂指标
2. **快速执行**：在5m K线关闭后立即开仓
3. **多重止损**：实时监控止损 + 移动止损（可选）+ 移动反向吞没止损
4. **风险可控**：多种止损机制，避免过度亏损
5. **实时通知**：完整的Telegram通知系统
6. **灵活持仓**：无固定持仓时间限制，由市场决定

## 注意事项

1. 确保WebSocket连接稳定
2. 确保账户余额充足
3. 注意市场波动风险
4. 关注手续费成本
5. 定期检查系统日志
6. 止损订单可能因市场剧烈波动而滑点

## 代码结构

### 主要文件
- `../src/strategy/fifteen_minute_strategy.py`：策略实现（类名为FiveMinuteStrategy）
- `../src/indicators/technical_analyzer.py`：技术指标计算
- `../src/trading/trading_executor.py`：交易执行
- `../src/trading/position_manager.py`：仓位管理
- `../src/telegram/telegram_client.py`：Telegram通知
- `../config.toml`：配置文件

### 关键方法
- `on_5m_kline_close()`：处理5m K线关闭（已关闭，触发开仓检查和止损检查）
- `_check_and_open_position()`：检查并开仓（基于已关闭的5m K线）
- `_check_volume_condition()`：检查成交量（基于已关闭的5m K线）
- `_check_range_condition()`：检查振幅（基于已关闭的5m K线）
- `_check_body_ratio()`：检查实体比例（基于已关闭的5m K线）
- `_calculate_stop_loss_price()`：计算止损价格
- `_check_real_time_stop_loss()`：检查实时监控止损
- `_check_engulfing_stop_loss()`：检查反向吞没止损

### 数据安全保证
- 所有开仓判断都基于**已关闭**的K线数据
- WebSocket事件只在K线完全关闭后才触发
- 确保数据的确定性和可重复性
- 避免使用未完成K线的不确定数据

### 状态持久化保证
- **启动时同步**：系统启动时自动从Binance API查询当前持仓
- **自动恢复**：将交易所的真实持仓状态同步到本地持仓管理器
- **风险防范**：避免程序重启后出现"逻辑空仓但真实有仓"的灾难性风险
- **一致性保证**：确保本地持仓状态与交易所持仓状态保持一致

## 策略变更说明

### 从15m策略到5m策略的主要变更

1. **移除15m周期概念**：不再有15m周期的限制
2. **开仓逻辑变更**：每次5m K线关闭都检查开仓条件，不再限制为第一个5m K线
3. **平仓逻辑变更**：移除15m K线关闭时的强制平仓，改为由止损条件决定平仓时机
4. **持仓时间**：无固定持仓时间限制，由市场走势决定
5. **仓位管理**：同时只能持有一个仓位（开新仓前必须先平掉旧仓）
6. **止损机制**：保留实时监控止损、移动止损（可选）和反向吞没止损，作为主要的平仓触发条件

### 优势
- 更灵活的交易机会捕捉
- 不受固定时间限制，让市场决定持仓时间
- 更快响应市场变化
- 减少因时间限制导致的强制平仓